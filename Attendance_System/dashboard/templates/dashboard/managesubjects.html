{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">

  <!-- Header -->
  <div class="dashboard-header flex justify-between items-center">
    <h2>Manage Subjects</h2>
    <a href="#" class="add-subject-btn" id="openModalSubject">+ Add Subject</a>
  </div>

  <!-- Add Subject Modal -->
  <div id="subjectModal" class="modal">
      <div class="modal-content">
          <span class="close">&times;</span>
          <h2>Add New Subject</h2>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="add_subject">
            <div class="form-group">
              <label for="{{ form.course.id_for_label }}">Course</label>
              {{ add_form.course }}
            </div>
            <div class="form-group">
              <label for="{{ form.subject_code.id_for_label }}">Subject Code</label>
              {{ add_form.subject_code }}
            </div>
            <div class="form-group">
              <label for="{{ form.description.id_for_label }}">Description</label>
              {{ add_form.description }}
            </div>
            <button type="submit" class="btn">Save</button>
          </form>
      </div>
  </div>

  <!-- Subjects Table -->
  <div class="bottom-section">
    <div class="attendance-box">
      <h3>Subject List</h3>
      <table class="recent-table">
        <thead>
          <tr>
            <th>Course</th>
            <th>Subject Code</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for subject in subjects %}
          <tr>
            <td>{{ subject.course }}</td>
            <td>{{ subject.subject_code }}</td>
            <td>{{ subject.description }}</td>
            <td>
              <a href="#" class="edit-btn" data-target="#editModal{{ subject.id }}">Edit</a>
              <a href="#" class="delete-btn" data-target="#deleteModal{{ subject.id }}">Delete</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" style="text-align:center;">No subjects found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Edit & Delete Modals -->
{% for subject in subjects %}
<!-- Edit Modal -->
<div id="editModal{{ subject.id }}" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Edit Subject</h2>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="subject_id" value="{{ subject.id }}">
      <input type="hidden" name="edit_subject" value="1">

      <div class="form-group">
        <label for="course">Course</label>
        <select name="course" required>
          {% for course in courses %}
          <option value="{{ course.id }}" {% if subject.course.id == course.id %}selected{% endif %}>
            {{ course.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="subject_code">Subject Code</label>
        <input type="text" name="subject_code" value="{{ subject.subject_code }}" required>
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <input type="text" name="description" value="{{ subject.description }}">
      </div>

      <button type="submit" class="btn">Update Subject</button>
    </form>
  </div>
</div>


<!-- Delete Modal -->
<div id="deleteModal{{ subject.id }}" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Delete Subject</h2>
    <p>Are you sure you want to delete <strong>{{ subject.subject_code }}</strong>?</p>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="delete_subject" value="1">
      <input type="hidden" name="subject_id" value="{{ subject.id }}">
      <button type="submit" class="btn btn-danger">Delete</button>
      <button type="button" class="btn close-btn">Cancel</button>
    </form>
  </div>
</div>
{% endfor %}

{% endblock %}

<!-- JS for Modal -->
<script>
document.addEventListener("DOMContentLoaded", function() {

  function openModal(modal) {
    modal.style.display = "block";

    // Close button inside modal
    const closeBtn = modal.querySelector(".close, .close-btn");
    if (closeBtn) {
      closeBtn.onclick = () => modal.style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function(e) {
      if (e.target == modal) {
        modal.style.display = "none";
      }
    }
  }

  // Add Subject modal
  const addModal = document.getElementById("subjectModal");
  const openAddBtn = document.getElementById("openModalSubject");
  openAddBtn.onclick = function(e) {
    e.preventDefault();
    openModal(addModal);
  }

  // Edit/Delete modals
  document.querySelectorAll(".edit-btn, .delete-btn").forEach(btn => {
    btn.addEventListener("click", function(e) {
      e.preventDefault();
      const modalId = btn.dataset.target;
      const modal = document.querySelector(modalId);
      openModal(modal);
    });
  });
});
</script>
