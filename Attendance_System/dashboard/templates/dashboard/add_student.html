{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">

  <div class="dashboard-header" style="margin-bottom: 30px;">
    <h2>Add Student</h2>
  </div>

  <form action="{% url 'accounts:add_student' %}" method="post" class="add-student-form">
    {% csrf_token %}

    <!-- Basic Info -->
    <div class="form-row">
      <div class="form-group">
        <label for="{{ student_form.student_ID.id_for_label }}">Student ID</label>
        {{ student_form.student_ID }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.first_name.id_for_label }}">First Name</label>
        {{ student_form.first_name }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.middle_name.id_for_label }}">Middle Name</label>
        {{ student_form.middle_name }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.last_name.id_for_label }}">Last Name</label>
        {{ student_form.last_name }}
      </div>
    </div>

    <!-- Course, Year, Section, Type -->
    <div class="form-row">
      <div class="form-group">
        <label for="{{ student_form.course.id_for_label }}">Course</label>
        {{ student_form.course }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.year.id_for_label }}">Year</label>
        {{ student_form.year }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.section.id_for_label }}">Section</label>
        {{ student_form.section }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.is_regular.id_for_label }}">Student Type</label>
        {{ student_form.is_regular }}
      </div>
    </div>

    <!-- Semester -->
    <div class="form-row semester-row">
      <label>Semester</label>
      <div class="semester-options">
        {% for value, label in student_form.fields.semester.choices %}
          <label class="radio-label">
            <input type="radio" name="semester" value="{{ value }}"
                   {% if student_form.fields.semester.initial == value %}checked{% endif %}>
            {{ label }}
          </label>
        {% endfor %}
      </div>
    </div>

    <!-- Subjects Table -->
    <div class="form-row">
      <label>Subjects</label>
      <table class="subjects-table">
        <thead>
          <tr>
            <th style="width:50px;">Select</th>
            <th>Subject Code</th>
            <th>Subject Name</th>
          </tr>
        </thead>
        <tbody id="subject-container">
          {% for subject in subjects %}
            <tr>
              <td style="text-align:center;">
                <input type="checkbox" name="subjects" value="{{ subject.id }}">
              </td>
              <td>{{ subject.subject_code }}</td>
              <td>{{ subject.name }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="form-row">
      <button type="submit" class="btn-save">Save Student</button>
    </div>

  </form>

</div>

<!-- Scripts -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  let manualSelections = new Set();

  function loadSubjects() {
    let semester = document.querySelector('input[name="semester"]:checked').value;
    let course = document.getElementById('id_course').value;
    let year = document.getElementById('id_year').value;
    let studentType = document.getElementById('id_is_regular').value;

    fetch("{% url 'accounts:load_subjects' %}?semester=" + semester + "&course=" + course + "&year=" + year)
      .then(response => response.json())
      .then(data => {
        const container = document.getElementById('subject-container');
        container.innerHTML = '';

        const isRegular = studentType === 'reg';

        data.subjects.forEach(sub => {
          let checked = isRegular ? 'checked' : (manualSelections.has(sub.id) ? 'checked' : '');
          const row = `
            <tr>
              <td style="text-align:center;">
                <input type="checkbox" name="subjects" value="${sub.id}" ${checked} class="subject-checkbox">
              </td>
              <td>${sub.subject_code}</td>
              <td>${sub.name}</td>
            </tr>`;
          container.innerHTML += row;
        });

        document.querySelectorAll('.subject-checkbox').forEach(cb => {
          cb.addEventListener('change', function() {
            const id = parseInt(this.value);
            if(this.checked) manualSelections.add(id);
            else manualSelections.delete(id);
          });
        });
      });
  }

  document.getElementById('id_course').addEventListener('change', loadSubjects);
  document.getElementById('id_year').addEventListener('change', loadSubjects);
  document.querySelectorAll('input[name="semester"]').forEach(el => el.addEventListener('change', loadSubjects));
  document.getElementById('id_is_regular').addEventListener('change', function() {
    if(this.value === 'irreg') manualSelections.clear();
    loadSubjects();
  });

  loadSubjects();
});
</script>

<style>
/* Form Layout */
.add-student-form .form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 20px;
}

.add-student-form .form-group {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.add-student-form label {
  font-weight: 500;
  margin-bottom: 5px;
  color: #111827;
}

.add-student-form input[type="text"],
.add-student-form select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  outline: none;
  transition: 0.3s;
}

.add-student-form input[type="text"]:focus,
.add-student-form select:focus {
  border-color: #4f46e5;
  box-shadow: 0 0 5px rgba(79, 70, 229, 0.3);
}

/* Semester Radio */
.semester-options {
  display: flex;
  gap: 15px;
  margin-top: 5px;
}

.radio-label input[type="radio"] {
  margin-right: 5px;
}

/* Subjects Table */
.subjects-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

.subjects-table th, .subjects-table td {
  border: 1px solid #ddd;
  padding: 10px;
  text-align: left;
}

.subjects-table th {
  background-color: #f3f4f6;
  font-weight: 600;
}

.subjects-table tr:nth-child(even) {
  background-color: #fafafa;
}

/* Save Button */
.btn-save {
  padding: 12px 25px;
  background-color: #4f46e5;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s;
}

.btn-save:hover {
  background-color: #4338ca;
}
</style>
{% endblock %}
