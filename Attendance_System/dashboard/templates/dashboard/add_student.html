{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">

  <div class="dashboard-header" style="margin-bottom: 30px;">
    <h2>Add Student</h2>
  </div>

  <form action="{% url 'accounts:add_student' %}" method="post" class="add-student-form" id="studentForm" onsubmit="return validateForm()">
    {% csrf_token %}

    <!-- Show all form errors -->
    {% for form in forms_list %}
      {% if form.errors %}
        <div class="error-container">
          <div class="error-title"><i>!</i> Please fix the errors below:</div>
          {{ form.non_field_errors }}
          {% for field in form %}
            {% for error in field.errors %}
              <div class="error-item">
                <strong>{{ field.label }}:</strong> {{ error }}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}

    <!-- Basic Info -->
    <div class="form-row">
      <div class="form-group">
        <label for="{{ student_form.student_ID.id_for_label }}">Student ID</label>
        {{ student_form.student_ID }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.first_name.id_for_label }}">First Name</label>
        {{ student_form.first_name }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.middle_name.id_for_label }}">Middle Name</label>
        {{ student_form.middle_name }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.last_name.id_for_label }}">Last Name</label>
        {{ student_form.last_name }}
      </div>
    </div>

    <!-- Course, Year, Section, Type -->
    <div class="form-row">
      <div class="form-group">
        <label for="{{ student_form.course.id_for_label }}">Course</label>
        {{ student_form.course }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.year.id_for_label }}">Year</label>
        {{ student_form.year }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.section.id_for_label }}">Section</label>
        {{ student_form.section }}
      </div>
      <div class="form-group">
        <label for="{{ student_form.is_regular.id_for_label }}">Student Type</label>
        {{ student_form.is_regular }}
      </div>
    </div>

    <!-- Semester -->
    <div class="form-row semester-row">
      <label>Semester</label>
      <div class="semester-options">
        {% for value, label in student_form.fields.semester.choices %}
          <label class="radio-label">
            <input type="radio" name="semester" value="{{ value }}"
                   {% if student_form.fields.semester.initial == value %}checked{% endif %}>
            {{ label }}
          </label>
        {% endfor %}
      </div>
    </div>

    <!-- Subjects Table -->
    <div class="form-row">
      <label>Subjects</label>
      <table class="subjects-table">
        <thead>
          <tr>
            <th style="width:50px;">Select</th>
            <th>Subject Code</th>
            <th>Subject Name</th>
          </tr>
        </thead>
        <tbody id="subject-container">
          {% for subject in subjects %}
            <tr>
              <td style="text-align:center;">
                <input type="checkbox" name="subjects" value="{{ subject.id }}">
              </td>
              <td>{{ subject.subject_code }}</td>
              <td>{{ subject.name }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Parent Section -->
    <h3>Parent Information</h3>

    <!-- Search & Select Existing Parent -->
    <div class="form-row">
      <div class="form-group">
        <label for="parent_search">Search Parent</label>
        <input type="text" id="parent_search" placeholder="Type to search..." autocomplete="off" class="input-field">

        <select id="parent_select" name="parent_select" size="5" class="select-field mt-2">
          <option value="">-- Select Existing Parent --</option>
          {% for parent in parents %}
            <option value="{{ parent.id }}">{{ parent.first_name }} {{ parent.middle_name }} {{ parent.last_name }} - {{ parent.contact_number }}</option>
          {% endfor %}
        </select>

        <button type="button" id="toggle_parent_inputs" class="btn-secondary mt-3">Add New Parent</button>
      </div>
    </div>

    <!-- New Parent Inputs -->
    <div id="new_parent_inputs" style="display:none;">
      <div class="form-row">
        <div class="form-group">
          <label for="{{ parent_profile_form.first_name.id_for_label }}">First Name</label>
          {{ parent_profile_form.first_name }}
        </div>
        <div class="form-group">
          <label for="{{ parent_profile_form.middle_name.id_for_label }}">Middle Name</label>
          {{ parent_profile_form.middle_name }}
        </div>
        <div class="form-group">
          <label for="{{ parent_profile_form.last_name.id_for_label }}">Last Name</label>
          {{ parent_profile_form.last_name }}
        </div>
        <div class="form-group">
          <label for="{{ parent_profile_form.contact_number.id_for_label }}">Contact Number</label>
          {{ parent_profile_form.contact_number }}
        </div>
      </div>
    </div>

    <div class="form-row">
      <button type="submit" class="btn-save">Save Student</button>
    </div>

  </form>

</div>

<!-- Scripts -->
<script>
function validateForm() {
  // Validation handled on backend
  return true;
}

document.addEventListener("DOMContentLoaded", function() {
  const toggleBtn = document.getElementById('toggle_parent_inputs');
  const newParentDiv = document.getElementById('new_parent_inputs');
  const parentSelect = document.getElementById('parent_select');
  const searchInput = document.getElementById('parent_search');

  function toggleParentFields(enable) {
    const inputs = newParentDiv.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      if(enable) {
        input.removeAttribute('disabled');
        if(input.dataset.originalRequired === 'true') input.setAttribute('required','required');
      } else {
        if(input.hasAttribute('required')) input.dataset.originalRequired='true';
        input.removeAttribute('required');
        input.setAttribute('disabled','disabled');
        input.value='';
      }
    });
  }

  toggleBtn.addEventListener('click', function(e){
    e.preventDefault();
    if(newParentDiv.style.display==='none'||newParentDiv.style.display===''){
      newParentDiv.style.display='block';
      parentSelect.value="";
      toggleParentFields(true);
      toggleBtn.textContent='Cancel (Use Existing Parent)';
    } else {
      newParentDiv.style.display='none';
      toggleParentFields(false);
      toggleBtn.textContent='Add New Parent';
    }
  });

  parentSelect.addEventListener('change', function(){
    if(this.value){
      newParentDiv.style.display='none';
      toggleParentFields(false);
      toggleBtn.textContent='Add New Parent';
    }
  });

  toggleParentFields(false);

  if(searchInput){
    searchInput.addEventListener('input', function(){
      const filter = this.value.toLowerCase();
      for(let i=0;i<parentSelect.options.length;i++){
        const option = parentSelect.options[i];
        option.style.display = option.text.toLowerCase().includes(filter)?'':'none';
      }
    });
  }

  // Subjects dynamic loading
  let manualSelections = new Set();
  function loadSubjects(){
    const semesterInput = document.querySelector('input[name="semester"]:checked');
    const courseSelect = document.getElementById('id_course');
    const yearSelect = document.getElementById('id_year');
    const studentTypeSelect = document.getElementById('id_is_regular');
    if(!semesterInput||!courseSelect||!yearSelect||!studentTypeSelect) return;

    fetch("{% url 'accounts:load_subjects' %}?semester="+semesterInput.value+"&course="+courseSelect.value+"&year="+yearSelect.value)
      .then(res=>res.json())
      .then(data=>{
        const container=document.getElementById('subject-container');
        container.innerHTML='';
        const isRegular=studentTypeSelect.value==='reg';
        data.subjects.forEach(sub=>{
          let checked = isRegular?'checked':(manualSelections.has(sub.id)?'checked':'');
          container.innerHTML+=`<tr>
            <td style="text-align:center;">
              <input type="checkbox" name="subjects" value="${sub.id}" ${checked} class="subject-checkbox">
            </td>
            <td>${sub.subject_code}</td>
            <td>${sub.name}</td>
          </tr>`;
        });
        document.querySelectorAll('.subject-checkbox').forEach(cb=>{
          cb.addEventListener('change',function(){
            const id=parseInt(this.value);
            if(this.checked) manualSelections.add(id);
            else manualSelections.delete(id);
          });
        });
      });
  }

  const courseSelect = document.getElementById('id_course');
  const yearSelect = document.getElementById('id_year');
  const studentTypeSelect = document.getElementById('id_is_regular');
  if(courseSelect) courseSelect.addEventListener('change',loadSubjects);
  if(yearSelect) yearSelect.addEventListener('change',loadSubjects);
  if(studentTypeSelect){
    studentTypeSelect.addEventListener('change',function(){
      if(this.value==='irreg') manualSelections.clear();
      loadSubjects();
    });
  }
  document.querySelectorAll('input[name="semester"]').forEach(el=>el.addEventListener('change',loadSubjects));

  loadSubjects();
});
</script>

<!-- Styles -->
<style>
.add-student-form .form-row{display:flex;flex-wrap:wrap;gap:20px;margin-bottom:20px;}
.add-student-form .form-group{flex:1;display:flex;flex-direction:column;}
.add-student-form label{font-weight:500;margin-bottom:5px;color:#111827;}
.add-student-form input[type="text"],.add-student-form select{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px;outline:none;transition:0.3s;}
.add-student-form input[type="text"]:focus,.add-student-form select:focus{border-color:#4f46e5;box-shadow:0 0 5px rgba(79,70,229,0.3);}
.semester-options{display:flex;gap:15px;margin-top:5px;}
.radio-label input[type="radio"]{margin-right:5px;}
.subjects-table{width:100%;border-collapse:collapse;margin-top:10px;}
.subjects-table th,.subjects-table td{border:1px solid #ddd;padding:10px;text-align:left;}
.subjects-table th{background-color:#f3f4f6;font-weight:600;}
.subjects-table tr:nth-child(even){background-color:#fafafa;}
.btn-save,.btn-secondary{padding:12px 25px;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:0.3s;}
.btn-save{background-color:#4f46e5;}
.btn-save:hover{background-color:#4338ca;}
.btn-secondary{background-color:#6b7280;}
.btn-secondary:hover{background-color:#4b5563;}
.error-container{background:#fff4f4;border-left:5px solid #e11d48;padding:15px 18px;border-radius:6px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
.error-title{color:#b91c1c;font-weight:bold;font-size:16px;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.error-title i{font-style:normal;background:#b91c1c;color:white;border-radius:50%;width:20px;height:20px;text-align:center;line-height:20px;font-size:13px;}
.error-item{background:#ffe6e6;padding:8px 12px;border-radius:5px;margin-bottom:6px;color:#7f1d1d;border:1px solid #f2b6b6;font-size:14px;}
.input-field,.select-field{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px;outline:none;transition:0.3s;margin-top:5px;}
.input-field:focus,.select-field:focus{border-color:#4f46e5;box-shadow:0 0 5px rgba(79,70,229,0.3);}
.select-field{height:150px;}
.mt-2{margin-top:8px;}
.mt-3{margin-top:12px;}
</style>

{% endblock %}
