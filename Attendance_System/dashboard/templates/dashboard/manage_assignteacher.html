{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="dashboard-container">

  <!-- Header -->
  <div class="dashboard-header flex justify-between items-center">
    <h2>Assign Teachers</h2>
    <a href="#" class="add-subject-btn" id="openModalAssign">+ Assign Teacher</a>
  </div>

  <!-- Add Assign Teacher Modal -->
  <div id="assignModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Assign Teacher to Subject</h2>
      <form method="post" action="{% url 'academics:add_assignment' %}">
        {% csrf_token %}
        <div class="form-group">
          <label>Teacher</label>
          {{ assign_subject_form.teacher }}
        </div>
        <div class="form-group">
          <label>Subject</label>
          {{ assign_subject_form.subject }}
        </div>
        <div class="form-group">
          <label>Year Level</label>
          {{ assign_subject_form.year }}
        </div>
        <div class="form-group">
          <label>School Year</label>
          {{ assign_subject_form.school_year }}
        </div>
        <button type="submit" class="btn">Save</button>
      </form>
    </div>
  </div>

  <!-- Assignments Table -->
  <div class="bottom-section">
    <div class="attendance-box">
      <h3>Assigned Teachers</h3>
      <table class="recent-table">
        <thead>
          <tr>
            <th>Teacher</th>
            <th>Subject</th>
            <th>Year</th>
            <th>Semester</th>
            <th>School Year</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for offering in offerings %}
          <tr>
            <td>{{ offering.teacher.first_name }} {{ offering.teacher.last_name }}</td>
            <td>{{ offering.subject.subject_code }} - {{ offering.subject.name }}</td>
            <td>{{ offering.year }}</td>
            <td>{{ offering.subject.semester_number }}</td>
            <td>{{ offering.school_year }}</td>
            <td>
              <a href="#" class="edit-btn" data-target="#editModal{{ offering.id }}">Edit</a>
              <a href="#" class="delete-btn" data-target="#deleteModal{{ offering.id }}">Delete</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="empty-row">No assignments found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Edit & Delete Modals -->
{% for offering in offerings %}
<div id="editModal{{ offering.id }}" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Edit Assignment</h2>
    <form method="post" action="{% url 'academics:edit_assignment' offering.id %}">
      {% csrf_token %}
      <div class="form-group">
        <label>Teacher</label>
        <select name="teacher" class="form-control" required>
          {% for t in teacher %}
          <option value="{{ t.id }}" {% if offering.teacher.id == t.id %}selected{% endif %}>
            {{ t.first_name }} {{ t.last_name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Subject</label>
        <select name="subject" class="form-control" required>
          {% for sub in subjects %}
          <option value="{{ sub.id }}" {% if offering.subject.id == sub.id %}selected{% endif %}>
            {{ sub.subject_code }} - {{ sub.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Year</label>
        <select name="year" class="form-control" required>
            <option value="1st" {% if offering.year == "1st" %}selected{% endif %}>1st Year</option>
            <option value="2nd" {% if offering.year == "2nd" %}selected{% endif %}>2nd Year</option>
            <option value="3rd" {% if offering.year == "3rd" %}selected{% endif %}>3rd Year</option>
            <option value="4th" {% if offering.year == "4th" %}selected{% endif %}>4th Year</option>
        </select>
      </div>

      <div class="form-group">
        <label>School Year</label>
        <input type="text" name="school_year" value="{{ offering.school_year }}" class="form-control" required>
      </div>
      <button type="submit" class="btn">Update Assignment</button>
    </form>
  </div>
</div>

<div id="deleteModal{{ offering.id }}" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Delete Assignment</h2>
    <p>Are you sure you want to delete the assignment of <strong>{{ offering.teacher.first_name }} {{ offering.teacher.last_name }}</strong>?</p>
    <form method="post" action="{% url 'academics:delete_assignment' offering.id %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">Delete</button>
      <button type="button" class="btn close-btn">Cancel</button>
    </form>
  </div>
</div>
{% endfor %}

<!-- JS for Modals -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  function openModal(modal) {
    modal.style.display = "block";
    const closeBtn = modal.querySelector(".close, .close-btn");
    if (closeBtn) closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = function(e) { if (e.target == modal) modal.style.display = "none"; }
  }

  const addModal = document.getElementById("assignModal");
  const openAddBtn = document.getElementById("openModalAssign");
  openAddBtn.onclick = function(e) { e.preventDefault(); openModal(addModal); }

  document.querySelectorAll(".edit-btn, .delete-btn").forEach(btn => {
    btn.addEventListener("click", function(e) {
      e.preventDefault();
      const modal = document.querySelector(this.dataset.target);
      if(modal) openModal(modal);
    });
  });
});
</script>
{% endblock %}
